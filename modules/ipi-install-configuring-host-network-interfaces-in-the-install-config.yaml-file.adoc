// This is included in the following assemblies:
//
// installing_bare_metal_ipi/ipi-install-installation-workflow.adoc

[id="configuring-host-network-interfaces-in-the-install-config.yaml-file_{context}"]
= (Optional) Configuring host network interfaces in the `install-config.yaml` file

During installation, you can set the `networkConfig` configuration setting in the `install-config.yaml` file to configure host network interfaces using NMState. To use the `networkConfig` configuration setting, you must provide an NMState YAML configuration.

[IMPORTANT]
====
Before configuring host network interfaces, review the OpenShift Container Platform 4.10 release notes.
====
 
 See link:https://nmstate.io/examples.html#interfaces-ethernet[NMState] for additional examples of the NMState syntax.

.Example
[source,yaml]
----
  hosts:
        - name: openshift-master-0
          role: master
          bmc:
            address: redfish+http://<out-of-band-ip>/redfish/v1/Systems/
            username: <user>
            password: <password>
            disableCertificateVerification: null
          bootMACAddress: <NIC1_mac_address>
          bootMode: UEFI
          rootDeviceHints:
            deviceName: "/dev/sda"
          networkConfig: <1>
            interfaces:
            - name: <NIC1_name>
              type: ethernet
              state: up
              ipv4:
                address:
                - ip: "<IP_address>"
                  prefix-length: 24
                enabled: true
            dns-resolver:
              config:
                server:
                - <DNS_IP_address>
            routes:
              config:
              - destination: 0.0.0.0/0
                next-hop-address: <IP_address>
                next-hop-interface: <NIC1_name>
----
<1> Add NMState YAML syntax to configure host interfaces.

[TIP]
====
Consider saving the `networkConfig` YAML syntax to a file and testing it using the NMState command line interface before including it in the `install-config.yaml` file, because the installation program will not check the NMState YAML syntax. Execute `nmstatectl gc <yaml-config>` to test the syntax. Errors in the YAML syntax might result in a failure to apply the network configuration. Additionally, maintaining the validated YAML syntax is useful when applying changes using Kubernetes NMState after deployment or when expanding the cluster.
====

During node configuration, ensure you are creating PTR records, so that the nodes are not displayed as `localhost`.

When configuring static IP addresses, be aware that while the cluster's nodes can be assigned a static IP address as part of the `install-config` file, the bootstrap VM cannot. In the case of configuring the bootstrap VM without a DHCP server, you will need to configure it using ignition, per the following example:

. Create a NetworkManager keyfile for the external NIC of the boostrap VM:

.Example
[source,yaml]
----
  BOOTSTRAP_CONFIG="[connection]
  type=ethernet
  interface-name=ens3
  [ethernet]
  [ipv4]
  method=manual
  addresses=${BOOTSTRAP_IP}/${BOOTSTRAP_PREFIX}
  gateway=${PROVISIONING_HOST_EXTERNAL_IP}
  dns=${PROVISIONING_HOST_EXTERNAL_IP}"
----

. Merge additional config into the generated bootstrap.ign before deployment:

.Example
[source,terminal]
----
  cat > bootstrap_network_config.ign << EOF
      {
        "path": "/etc/NetworkManager/system-connections/ens3.nmconnection",
        "mode": 384,
        "contents": {
        "source": "data:text/plain;charset=utf-8;base64,$(echo "${BOOTSTRAP_CONFIG}" | base64 -w 0)"
        }
      }
  EOF
  openshift-baremetal-install --dir foo create ignition-configs
  mv foo/bootstrap.ign foo/bootstrap.ign.orig
  jq '.storage.files += $input' foo/bootstrap.ign.orig --slurpfile input bootstrap_network_config.ign > foo/bootstrap.ign
  openshift-baremetal-install --dir foo create cluster
----

[IMPORTANT]
====
Once deployed, you cannot modify the `networkConfig` configuration setting of `install-config.yaml` file to make changes to the host network interface. Use the Kubernetes NMState Operator to make changes to the host network interface after deployment.
====