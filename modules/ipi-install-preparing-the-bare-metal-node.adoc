// This is included in the following assemblies:
//
// installing/installing_bare_metal_ipi/ipi-install-expanding-the-cluster.adoc

:_content-type: PROCEDURE
[id='preparing-the-bare-metal-node_{context}']
= Preparing the bare metal node

Expanding the cluster requires a DHCP server. Each node must have a DHCP reservation.

[IMPORTANT]
.Reserving IP addresses so they become static IP addresses
====
Some administrators prefer to use static IP addresses so that each node's IP address remains constant in the absence of a DHCP server. To configure static IP addresses with NMState, see "(Optional) Configuring host network interfaces in the `install-config.yaml` file" in the "Setting up the environment for an OpenShift installation" section for additional details.
====

Preparing the bare metal node requires executing the following procedure from the provisioner node.

.Procedure

. Get the `oc` binary, if needed. It should already exist on the provisioner node.
+
[source,terminal]
----
$ curl -s https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$VERSION/openshift-client-linux-$VERSION.tar.gz | tar zxvf - oc
----
+
[source,terminal]
----
$ sudo cp oc /usr/local/bin
----

. Power off the bare metal node by using the baseboard management controller, and ensure it is off.

. Retrieve the user name and password of the bare metal node's baseboard management controller. Then, create `base64` strings from the user name and password:
+
[source,terminal,subs="+quotes"]
----
$ echo -ne "root" | base64
----
+
[source,terminal]
----
$ echo -ne "password" | base64
----

. Create a configuration file for the bare metal node using the following example `bmh.yaml` file, replacing values in the YAML to match your environment:
+
[source,yaml]
----
---
apiVersion: v1
 kind: Secret
 metadata:
 name: openshift-worker-<num>-network
 type: Opaque
 stringData:
 nmstate: |
  routes:
   config:
   - destination: 0.0.0.0/0
    next-hop-address: <server_ip_address>
    next-hop-interface: enp0s4
  dns-resolver:
   config:
    server:
    - <server_ip_address>
  interfaces:
  - name: enp0s4
   state: up
   ipv4:
    address:
    - ip: <interface_ip_address>
     prefix-length: 24
    enabled: true
    dhcp: false
---
apiVersion: v1
kind: Secret
metadata:
  name: openshift-worker-<num>-bmc-secret
  namespace: openshift-machine-api
type: Opaque
data:
  username: <base64_of_uid>
  password: <base64_of_pwd>
---
apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  name: openshift-worker-<num>
  namespace: openshift-machine-api
spec:
  online: True
  bmc:
    address: <protocol>://<bmc_ip>
    credentialsName: openshift-worker-<num>-bmc-secret
    disableCertificateVerification: True
    username: <user_name>
    password: <password>
  bootMACAddress: <nic1_mac_address>
  rootDeviceHints:
    deviceName: /dev/sda
 preprovisioningNetworkDataName: openshift-worker-<num>-network
----
+
[NOTE]
====
If the MAC address of an existing bare metal node matches the MAC address of a bare metal host that you are attempting to provision, then the Ironic installation will fail. If the host enrollment, inspection, cleaning, or other Ironic steps fail, the Bare Metal Operator retries the installation continuously. See "Diagnosing a host duplicate MAC address" for more information.
====

. Create the bare metal node.
+
[source,terminal]
----
$ oc -n openshift-machine-api create -f bmh.yaml
----
+
.Example output
[source,terminal]
----
secret/openshift-worker-<num>-bmc-secret created
baremetalhost.metal3.io/openshift-worker-<num> created
----
+
Where `<num>` will be the worker number.

. Power up and inspect the bare metal node.
+
[source,terminal]
----
$ oc -n openshift-machine-api get bmh openshift-worker-<num>
----
+
Where `<num>` is the worker node number.
+
.Example output
[source,terminal]
----
NAME                    STATE       CONSUMER   ONLINE   ERROR
openshift-worker-<num>  available              true
----
